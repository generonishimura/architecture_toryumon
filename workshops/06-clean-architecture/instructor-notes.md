# 第6回 クリーンアーキテクチャ — 講師補助資料

## この回の核心

> 「ビジネスロジックを外部の詳細から守ることが、変更容易性の鍵」

同心円図は有名だが「図を知っている」と「実装できる」は別物。TypeScriptのプロジェクト構成で依存の方向を実感させることが目標。

## 講師の事前準備チェックリスト

- [ ] 4層構造（Domain / Application / Infrastructure / Presentation）のサンプルプロジェクトを手元で動く状態にする
- [ ] 「依存の方向が内側に向かう」ことをimport文で確認できるコード例を準備する
- [ ] 「クリーンアーキテクチャを導入しすぎて辛くなった」事例を1つ用意する（過度な抽象化の弊害）
- [ ] 手動DIとNestJSのDIコンテナの両方のコード例を準備する
- [ ] 第1回（DIP）→ 第4回（Repository, Adapter）→ 第5回（ドメインモデル）の知識がここで統合されることを整理する

## 時間配分ガイド

| パート | 配分 | 注意点 |
|--------|------|--------|
| 前回振り返り | 5分 | DDD の集約・値オブジェクトを確認 |
| なぜアーキテクチャが必要か | 10分 | 変更コストの増大グラフで動機づけ |
| **全体像（同心円モデル）** | **20分** | 図を描きながら依存ルールを何度も強調 |
| **各レイヤーの役割** | **30分** | コードを見せながら説明。1レイヤー5〜8分 |
| **Node.js/TSでの実装** | **25分** | ディレクトリ構成 + DI がポイント |
| よくある誤解と注意 | 10分 | 「やりすぎ」への処方箋 |
| 休憩 | 10分 | |
| ディスカッション + Q&A | 20分 | |

## 各トピックの教え方のポイント

### 同心円モデルと依存ルール
- **「依存は常に内側に向かう」を呪文のように繰り返す**
- 同心円図を描いたあと、矢印（依存方向）を描く。「この矢印が外向きになったら設計が壊れる」
- 「内側は外側を知らない。知る必要がない。」を体感させるために、Domain層のimportに `express` や `prisma` が一切ないことを示す

### 各レイヤーの実装
- **Domain層:** 第5回で作ったOrder, Money, OrderPlacedをそのまま使う。「前回のコードがここにそのまま入る」
- **Application層（UseCase）:** 「1ユースケース = 1クラス」が基本。Input/Outputの型を明示することで、何が入って何が出るかが一目瞭然になる
- **Infrastructure層:** PrismaOrderRepository は OrderRepository インターフェースを implements する。「Prismaが変わってもDomain層は影響を受けない」
- **Presentation層:** Express Controller は UseCase を呼ぶだけ。ビジネスロジックを書かない

### DI（依存性注入）
- まず手動DIを見せる:「main.tsで全部つなぐ」
- 次にNestJSのDIコンテナ:「@Injectable()でフレームワークが自動でやってくれる」
- **問いかけ:** 「どちらが好み？プロジェクト規模で使い分けるとしたら？」

### よくある誤解
- 「クリーンアーキテクチャ＝ディレクトリ構造」→ 構造ではなく依存の方向が本質
- 「全レイヤーが常に必要」→ 小規模なら2〜3層でも十分
- 「DTO変換が面倒」→ それは意図的なコスト。レイヤー間の結合を切るための投資

## 想定される質問と回答例

| 質問 | 回答の方向性 |
|------|-------------|
| 「小さいプロジェクトでもやるべき？」 | 「全レイヤーは不要。だが『ビジネスロジックにDBの依存を入れない』だけでも効果がある。最小限の適用から始める」 |
| 「DTO変換のボイラープレートが多くないですか」 | 「多い。これは意図的なトレードオフ。レイヤー間の独立性を買っている。小規模ならDTO省略も選択肢」 |
| 「NestJSを使えば自動的にクリーンアーキテクチャになる？」 | 「ならない。NestJSのModule/Controllerはあくまでフレームワークの構造。依存の方向は自分で設計する必要がある」 |
| 「Hexagonal, Onion, Clean の違いは？」 | 「核心は同じ（ビジネスロジックを中心に置く）。用語や層の分け方が少し異なるだけ。プロジェクトに合う方を採用すればよい」 |

## ディスカッションの注意点

「レイヤーの粒度」のテーマでは、参加者から「4層は面倒」という意見が出やすい。これを否定せず、「どこまでやるかはプロジェクトの複雑さ次第」と認めた上で、「依存の方向だけは守ろう」に帰結させる。

## 次回（第7回 マイクロサービス）への橋渡し

- 「今日までは『1つのアプリケーション内』の設計でした。次回からは『複数のアプリケーション（サービス）に分割する』話に入ります」
- 「第5回で学んだ境界づけられたコンテキストが、サービス分割の単位になります。DDDの戦略的設計がここで活きます」
- 「フェーズ3（分散システム編）に入ります。概念のスケールが一段上がります」
