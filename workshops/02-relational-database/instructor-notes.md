# 第2回 リレーショナルデータベース — 講師補助資料

## この回の核心

> 「データの整合性を守る仕組みを理解し、適切に活用する」

この回は知識レベルA（実務経験必須）。参加者は「SQLは書けるけど設計の裏側は知らない」状態が多い。**なぜそうなっているか** を実務経験を交えて説明できることが講師の価値。

## 講師の事前準備チェックリスト

- [ ] 正規化のBefore/After例をホワイトボードで描けるよう練習する
- [ ] EXPLAIN ANALYZE の出力例を2〜3パターン準備する（インデックスあり/なし）
- [ ] デッドロックの実体験エピソードを1つ用意する
- [ ] 「非正規化してパフォーマンスを改善した」実例を1つ準備する
- [ ] PostgreSQL / MySQL のトランザクション分離レベルの違いを整理しておく

## 時間配分ガイド

| パート | 配分 | 注意点 |
|--------|------|--------|
| 前回振り返り | 5分 | SOLID原則を1人に1文で言ってもらう |
| RDB基本概念 | 10分 | 知っている人が多いので手短に |
| **正規化** | **30分** | 図を多用する。テキストだけでは伝わらない |
| **インデックス** | **25分** | B-Treeの概念図は必須。EXPLAIN の実演が効果的 |
| **トランザクション** | **25分** | ACID→分離レベル→デッドロックの順 |
| TypeScript/Node.jsからの操作 | 15分 | Prismaのコード例で実感させる |
| 休憩 | 10分 | |
| ディスカッション + Q&A | 20分 | |

## 各トピックの教え方のポイント

### 正規化
- **最初に非正規化されたテーブルを見せる。** 「何が問題か？」を参加者に考えさせてから正規形を説明する
- 更新時異常を具体的に示す:「このテーブルでユーザーの住所を変更するとき、何行更新が必要？」
- 第3正規形まででOK。BCNFや第4正規形は深追いしない

### インデックス
- B-Treeの図を簡略的に描いて「辞書の索引と同じ」と伝える
- **複合インデックスのカラム順序が最重要ポイント。** `(user_id, status)` と `(status, user_id)` で効くクエリが違うことを実例で示す
- 「インデックスを張れば速くなる」という思い込みを崩す:書き込みコストとストレージコスト

### トランザクション分離レベル
- ダーティリード → ノンリピータブルリード → ファントムリード の順に、具体的な業務シナリオで示す
- 「銀行の送金処理」が最も直感的な例
- 分離レベルのデフォルト値がPostgreSQL（READ COMMITTED）とMySQL（REPEATABLE READ）で異なることは実務で重要

### デッドロック
- 「2つのトランザクションが互いのロックを待つ」を図で示す
- 防止策: ロック順序の統一、タイムアウト設定

## 想定される質問と回答例

| 質問 | 回答の方向性 |
|------|-------------|
| 「NoSQLとの使い分けは？」 | 「この回はRDBに集中。簡単に言えば、整合性重視ならRDB、柔軟性・スケーラビリティ重視ならNoSQL。第7回のマイクロサービスで再度触れる」 |
| 「ORMを使っていればインデックスは意識しなくていい？」 | 「ORMはSQLを生成するだけ。インデックスの設計はORM任せにできない。EXPLAIN で生成されたSQLの実行計画を確認する習慣が大事」 |
| 「どのくらい正規化すればいいですか？」 | 「まず第3正規形にする。その上でパフォーマンス要件に基づいて意図的に非正規化する。理由なく非正規化されたテーブルが一番厄介」 |
| 「楽観的ロックと悲観的ロックの違いは？」 | 「悲観的＝先にロックして排他制御。楽観的＝更新時にバージョン番号で衝突検知。Webアプリでは楽観的ロックが主流」 |

## 実演・デモのアイデア

- **EXPLAIN ANALYZE のライブデモ:** 同じクエリにインデックスあり/なしで実行し、実行時間の差を見せる
- **デッドロック再現デモ:** 2つのターミナルで交差するUPDATEを実行し、デッドロックを実際に発生させる
- **非正規化テーブルの更新異常デモ:** 「住所を変更するのに5行更新が必要」を実際に見せる

## 次回（第3回 データモデリング）への橋渡し

- 「今日は既存のテーブルに対する設計原則を学びました。次回は『ビジネス要件からテーブルをどう設計するか』のプロセスを学びます」
- 「概念モデル → 論理モデル → 物理モデル の3段階を踏むことで、今日学んだ正規化やインデックスが自然に組み込まれます」
