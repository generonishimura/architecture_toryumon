# 第7回 マイクロサービス — 講師補助資料

## この回の核心

> 「分割はコストを伴う。モノリスから始めて、必要に応じて分割する」

知識レベルA（実務経験必須）。マイクロサービスへの過度な期待をコントロールしつつ、適切な分割判断ができる知識を提供する。**「マイクロサービスはすごい」ではなく「トレードオフを理解する」がゴール。**

## 講師の事前準備チェックリスト

- [ ] モノリス → マイクロサービスへの移行で苦労した/成功した実体験を2つ以上準備する
- [ ] 「分割しすぎて失敗した」（ナノサービス化）の事例を1つ準備する
- [ ] サービス分割の判断基準を自分の言葉で3つ以上列挙できるようにする
- [ ] REST vs gRPC の具体的な使い分け場面を整理する
- [ ] Circuit Breaker のコード例を動作確認する
- [ ] 第5回のコンテキストマップ → サービス境界の対応を図で描けるようにする

## 時間配分ガイド

| パート | 配分 | 注意点 |
|--------|------|--------|
| 前回振り返り | 5分 | クリーンアーキテクチャの依存ルールを確認 |
| モノリス → マイクロサービス | 15分 | モジュラーモノリスにも言及 |
| **サービス分割の原則** | **25分** | DDDとの接続がポイント。「分割しすぎ」を強調 |
| **サービス間通信** | **25分** | REST / gRPC / 非同期の使い分け |
| データ管理 | 20分 | Database per Serviceの理由と課題 |
| 実践的な考慮事項 | 15分 | Circuit Breaker、可観測性 |
| 休憩 | 10分 | |
| ディスカッション + Q&A | 20分 | |

## 各トピックの教え方のポイント

### モノリスからマイクロサービスへ
- **最初にモノリスのメリットを語る。** 「シンプル、デバッグ容易、トランザクション容易」
- その上で「組織が大きくなりデプロイ頻度を上げたいとき」に限界が来ることを示す
- **モジュラーモノリス** を必ず選択肢として提示する。「いきなりマイクロサービスにしなくてよい」

### サービス分割の原則
- 第5回のコンテキストマップをそのまま使い、「各コンテキスト ≒ 1サービス」を示す
- コンウェイの法則:「チーム構造がアーキテクチャに反映される」→ 逆に「アーキテクチャに合わせてチームを組む」（逆コンウェイ戦略）
- **分割の判断基準** を議論形式で引き出す:「どんな時にサービスを分割したくなりますか？」

### 分割しすぎの危険
- ネットワーク通信のレイテンシ、部分障害、分散トランザクション、運用コスト
- **「ローカルのメソッド呼び出しがネットワーク越しになる」ことのインパクト** を数字で示す（μs → ms）
- 「2つのサービスが常にセットでデプロイされるなら、分割する意味がない」

### サービス間通信
- 同期（REST, gRPC）と非同期（メッセージキュー）の使い分け表を示す
- REST:「すぐに結果が欲しい場合」、非同期:「処理を依頼するだけで結果を待たなくていい場合」
- BFF / API Gatewayはフロントエンド開発経験者がいると議論が盛り上がる

### Database per Service
- 「なぜDBを共有してはいけないのか」→ スキーマ変更が全サービスに波及する、サービスの独立デプロイが不可能になる
- ただし「データの結合が必要な場面」は必ずある。API Composition や CQRS（第9回で詳しく）で対処

## 想定される質問と回答例

| 質問 | 回答の方向性 |
|------|-------------|
| 「うちのプロジェクトはマイクロサービスにすべき？」 | 「チームが10人以下で、デプロイ頻度が週1〜2回なら、モジュラーモノリスで十分な可能性が高い。マイクロサービスは組織スケーリングの解決策」 |
| 「マイクロサービスで分散トランザクションはどうする？」 | 「基本的には避ける。どうしても必要な場合はSagaパターン（第9回で詳しく扱う）」 |
| 「gRPCとRESTはどう使い分ける？」 | 「サービス間内部通信はgRPC（型安全、高速）。外部公開APIはREST（広く普及、ブラウザ対応）。ただし全部RESTで始めるのも合理的」 |
| 「マイクロサービスにしたらテストはどうなる？」 | 「各サービスの単体テストは容易になる。一方、サービス間のE2Eテストは複雑化する。Contract Testingの導入を検討」 |

## ディスカッションの注意点

「モノリス vs マイクロサービス」のテーマは白熱しやすい。**二項対立にならないよう** 「モジュラーモノリス」という中間の選択肢を常に提示する。「正解はプロジェクトの状況で変わる」に帰結させる。

## 次回（第8回 オーケストレーション）への橋渡し

- 「今日はサービスの設計を学びました。次回は『設計したサービスをどうデプロイ・管理・スケーリングするか』を学びます」
- 「Docker / Kubernetes / CI/CD が中心になります。Dockerを使ったことがない方は、`docker run hello-world` だけでも試しておくと理解が早まります」
